
<script>
  const client = mqtt.connect("wss://e4fa5bda5dea4c8fab6d31e942111138.s1.eu.hivemq.cloud:8884/mqtt", {
    username: "usuario_smartsaag",
    password: "SmartSaag2025!"
  });

  const topic = "smartsaag/aquaponia/dados";

  client.on("connect", () => {
    console.log("Conectado ao MQTT remoto!");
    client.subscribe(topic, err => {
      if (!err) console.log("Inscrito no tópico:", topic);
    });
  });

  let dadosTemp = [];
  let dadosUmid = [];
  let labels = [];

  const ctxTemp = document.getElementById('chartTemp').getContext('2d');
  const chartTemp = new Chart(ctxTemp, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Temperatura (°C)',
        data: dadosTemp,
        borderColor: 'red',
        fill: false
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: false } }
    }
  });

  const ctxUmid = document.getElementById('chartUmid').getContext('2d');
  const chartUmid = new Chart(ctxUmid, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Umidade (%)',
        data: dadosUmid,
        borderColor: 'green',
        fill: false
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: false } }
    }
  });

  const ctxOxig = document.getElementById('chartOxig').getContext('2d');
  const chartOxig = new Chart(ctxOxig, {
    type: 'bar',
    data: {
      labels: ['Leitura Atual'],
      datasets: [{
        label: 'Oxigênio Dissolvido (mg/L)',
        data: [0],
        backgroundColor: 'darkblue'
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, suggestedMax: 15 } }
    }
  });

  client.on("message", (topic, message) => {
    const payload = JSON.parse(message.toString());
    const temp = payload.temperatura;
    const umid = payload.umidade;
    const oxig = payload.oxigenio;
    const now = new Date().toLocaleTimeString();

    document.getElementById('temp').textContent = temp;
    document.getElementById('umid').textContent = umid;
    document.getElementById('oxig').textContent = oxig;

    if (labels.length > 20) {
      labels.shift();
      dadosTemp.shift();
      dadosUmid.shift();
    }

    labels.push(now);
    dadosTemp.push(temp);
    dadosUmid.push(umid);

    chartTemp.update();
    chartUmid.update();
    chartOxig.data.datasets[0].data[0] = oxig;
    chartOxig.update();

    // Envia para Google Sheets via Google Apps Script
    fetch("https://script.google.com/macros/s/AKfycbye2xuc_jOcPstV96jnP1rfC_DvglnLC9sMeP7ei0jRg4tnx_p90BFvdHzffRo2Q5z02g/exec", {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        temperatura: temp,
        umidade: umid,
        oxigenio: oxig
      })
    })
    .then(() => console.log("Dados enviados para o Google Sheets."))
    .catch(err => console.error("Erro ao enviar para planilha:", err));
  });
</script>
